<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized File Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        /* Removed the separate progress-bar style as it's now integrated into the button */
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        function App() {
            // --- State Management ---
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [files, setFiles] = useState([]);

            // --- Check Login Status on Load ---
            useEffect(() => {
                const checkUserStatus = async () => {
                    try {
                        const response = await fetch('/api/me');
                        const data = await response.json();
                        if (data.loggedIn) {
                            setUser({ name: data.userName });
                        }
                    } catch (err) {
                        console.error("Failed to check user status:", err);
                    } finally {
                        setIsLoading(false);
                    }
                };
                checkUserStatus();
            }, []);
            
            // --- Fetch File History on Login ---
            const fetchFiles = useCallback(async () => {
                if (user) {
                    try {
                        const response = await fetch('/api/files');
                        const data = await response.json();
                        setFiles(data);
                    } catch (err) {
                        console.error("Failed to fetch files:", err);
                    }
                }
            }, [user]);

            useEffect(() => {
                fetchFiles();
            }, [fetchFiles]);

            const handleLogout = async () => {
                await fetch('/api/logout', { method: 'POST' });
                setUser(null);
                setFiles([]);
            };
            
            const addFileToList = (newFile) => {
                setFiles(prevFiles => [newFile, ...prevFiles]);
            }
            
            const handleFileDelete = (fileId) => {
                setFiles(prevFiles => prevFiles.filter(file => file.fileId !== fileId));
            }

            // --- Render Logic ---
            if (isLoading) {
                return <div className="min-h-screen flex items-center justify-center text-gray-700">Loading...</div>;
            }

            return (
                <div className="min-h-screen bg-gray-100 text-gray-800">
                    <header className="bg-white shadow-sm p-4 flex justify-between items-center">
                         <div className="flex items-center space-x-3">
                            <svg className="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <h1 className="text-xl font-bold text-gray-700">Decentralized File Share</h1>
                        </div>
                        {user && (
                             <div className="flex items-center space-x-4">
                                <span className="text-gray-600">Welcome, {user.name}</span>
                                <button onClick={handleLogout} className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm transition">
                                    Logout
                                </button>
                            </div>
                        )}
                    </header>
                    
                    <main className="p-4 md:p-8">
                        {user ? (
                            <MainLayout files={files} addFileToList={addFileToList} onFileDelete={handleFileDelete} />
                        ) : (
                            <LoginScreen />
                        )}
                    </main>
                    <footer className="text-center p-4 text-gray-500 text-sm">
                         Â© 2025 Myo ZarNi Aung. All rights reserved.
                    </footer>
                </div>
            );
        }
        
        const LoginScreen = () => (
            <div className="text-center max-w-lg mx-auto mt-20 p-8 bg-white rounded-xl shadow-md animate-fade-in">
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Welcome!</h2>
                <p className="text-gray-600 mb-6">Please log in with your Google account to securely share files from your Drive.</p>
                <a href="/api/auth/google/login" className="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                  Login with Google
                </a>
            </div>
        );
        
        const MainLayout = ({ files, addFileToList, onFileDelete }) => (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
                <div className="lg:col-span-1">
                    <UploadForm addFileToList={addFileToList} />
                </div>
                <div className="lg:col-span-2">
                    <FileTable files={files} onFileDelete={onFileDelete} />
                </div>
            </div>
        );
        
        const UploadForm = ({ addFileToList }) => {
            const [selectedFile, setSelectedFile] = useState(null);
            const [passcode, setPasscode] = useState('');
            const [expireDate, setExpireDate] = useState('');
            const [isUploading, setIsUploading] = useState(false);
            const [error, setError] = useState('');
            const [progress, setProgress] = useState(0);
            const [dragActive, setDragActive] = useState(false);
            const inputRef = useRef(null);
            
            const handleFileChange = (files) => {
                if (files && files[0]) {
                    setSelectedFile(files[0]);
                }
            }
            
            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFileChange(e.dataTransfer.files);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!selectedFile) {
                    setError('Please select a file to upload.');
                    return;
                }
                setIsUploading(true);
                setError('');
                setProgress(0);

                const formData = new FormData();
                formData.append('file', selectedFile);
                if (passcode) formData.append('passcode', passcode);
                if (expireDate) formData.append('expireDate', expireDate);

                const progressInterval = setInterval(() => {
                    setProgress(oldProgress => {
                        if (oldProgress >= 95) {
                            clearInterval(progressInterval);
                            return oldProgress;
                        }
                        return oldProgress + 5;
                    });
                }, 200);

                try {
                    const response = await fetch('/api/upload', { method: 'POST', body: formData });
                    
                    const contentType = response.headers.get("content-type");
                    if (!response.ok || !contentType || !contentType.includes("application/json")) {
                        throw new Error('Server timed out processing the large file. Please check your file history; the upload may have succeeded despite this error.');
                    }
                    
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);
                    
                    setProgress(100);
                    addFileToList({
                        fileId: result.fileId,
                        fileName: selectedFile.name,
                        shortUrl: result.shortUrl,
                        hasPasscode: !!passcode,
                        expireDate: expireDate,
                        uploadTimestamp: new Date().toISOString()
                    });
                    // Reset form
                    setSelectedFile(null);
                    setPasscode('');
                    setExpireDate('');
                } catch (err) {
                    setError(err.message);
                } finally {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        setIsUploading(false);
                        setProgress(0);
                    }, 1500);
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">Upload New File</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div 
                            onDragEnter={handleDrag} 
                            onDragLeave={handleDrag} 
                            onDragOver={handleDrag} 
                            onDrop={handleDrop}
                            onClick={() => inputRef.current.click()}
                            className={`flex justify-center items-center w-full h-32 px-6 transition bg-white border-2 ${dragActive ? "border-blue-500 bg-blue-50" : "border-gray-300"} border-dashed rounded-md cursor-pointer`}>
                            <div className="space-y-1 text-center">
                                <svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                <p className="text-sm text-gray-600">
                                    <span className="font-semibold text-blue-600">Click to upload</span> or drag and drop
                                </p>
                                {selectedFile ? 
                                    <p className="text-xs text-gray-500">{selectedFile.name}</p> :
                                    <p className="text-xs text-gray-500">Any file up to 5TB</p>
                                }
                            </div>
                            <input ref={inputRef} type="file" className="hidden" onChange={(e) => handleFileChange(e.target.files)} />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700">Passcode (Optional)</label>
                            <input type="password" value={passcode} onChange={e => setPasscode(e.target.value)} placeholder="Protect your file" className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Expiration Date (Optional)</label>
                            <input type="date" value={expireDate} onChange={e => setExpireDate(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        
                        {error && <p className="text-sm text-red-600 p-2 bg-red-100 rounded-md">{error}</p>}

                        {/* UPDATE: This button now shows the progress */}
                        <button 
                            type="submit" 
                            disabled={isUploading || !selectedFile} 
                            style={isUploading ? {
                                background: `linear-gradient(to right, #3b82f6 ${progress}%, #9ca3af ${progress}%)`,
                                transition: 'background 0.3s ease'
                            } : {}}
                            className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:text-gray-200"
                        >
                            {isUploading ? `Uploading... ${progress}%` : 'Upload & Get Link'}
                        </button>
                    </form>
                </div>
            );
        }
        
        const FileTable = ({ files, onFileDelete }) => {
            const [copySuccess, setCopySuccess] = useState('');

            const handleCopy = (url) => {
                navigator.clipboard.writeText(url);
                setCopySuccess(url);
                setTimeout(() => setCopySuccess(''), 2000);
            };
            
            const handleDeleteClick = async (file) => {
                if (window.confirm(`Are you sure you want to delete "${file.fileName}"? This action cannot be undone.`)) {
                    try {
                         const response = await fetch('/api/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fileId: file.fileId, shortUrl: file.shortUrl })
                        });
                        if (!response.ok) {
                            throw new Error('Failed to delete the file.');
                        }
                        onFileDelete(file.fileId);
                    } catch (err) {
                        alert(err.message);
                    }
                }
            };

            if (files.length === 0) {
                return (
                    <div className="bg-white p-6 rounded-xl shadow-md text-center">
                        <h3 className="text-lg font-bold text-gray-800 mb-2">My Files</h3>
                        <p className="text-gray-500">You haven't uploaded any files yet. Use the form on the left to get started.</p>
                    </div>
                );
            }
            
            return (
                 <div className="bg-white p-6 rounded-xl shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">My Files</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expires</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Protection</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {files.map((file, index) => (
                                    <tr key={file.fileId || index}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs">{file.fileName}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <button onClick={() => handleCopy(file.shortUrl)} className="text-blue-600 hover:text-blue-800">
                                                {copySuccess === file.shortUrl ? 'Copied!' : 'Copy Link'}
                                            </button>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{file.expireDate || 'Never'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {file.hasPasscode ? 
                                                <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Passcode</span> : 
                                                <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">None</span>}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <button onClick={() => handleDeleteClick(file)} className="text-red-600 hover:text-red-800">Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
